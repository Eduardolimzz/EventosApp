<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <title>EventosApp</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <style>
        /* Estilos Gerais do Corpo */
        body {
            background: #212121; /* Fundo escuro */
            color: #e0e0e0; /* Cor de texto clara */
            font-family: 'Roboto', sans-serif; /* Fonte moderna */
            min-height: 100vh; /* Altura total da viewport */
        }
        /* Contêiner para o conteúdo principal */
        .container {
            margin-top: 20px;
        }
        /* Título da Página */
        h1 {
            color: #ffffff;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5); /* Sombra sutil para profundidade */
            margin: -30px 0 30px 0;
            font-weight: 300;
        }

        /* Seção de Navegação */
        .nav-section {
            margin-bottom: 30px;
            padding-top: 10px;
            text-align: left;
            margin-left: -280px; /* Ajustar conforme necessário, pode ser específico para seu layout */
        }
        /* Botões de Navegação */
        .nav-btn {
            background: linear-gradient(45deg, #2196F3, #1976D2) !important; /* Gradiente azul */
            border-radius: 8px;
            margin: 5px;
            transition: all 0.3s ease; /* Transição suave para efeitos de hover */
        }
        .nav-btn:hover {
            transform: translateY(-2px); /* Leve levantamento ao passar o mouse */
        }

        /* Card Principal de Detalhes do Evento */
        .main-card {
            background: transparent;
            border: none;
            box-shadow: none;
            margin-bottom: 30px;
        }
        .card-content {
            padding: 30px !important;
        }
        .card-title {
            color: #ffffff !important;
            font-size: 28px !important;
            font-weight: bold !important;
            margin-bottom: 30px !important;
            text-align: center;
        }

        /* Seção de Informações do Evento */
        .event-info .row {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            gap: 15px; /* Espaçamento entre os itens do evento */
            margin-bottom: 0;
        }
        /* Item Individual do Evento (ex: Nome, Local) */
        .event-item {
            background: rgba(30, 30, 30, 0.6); /* Fundo escuro semi-transparente */
            backdrop-filter: blur(10px); /* Efeito de desfoque para um visual moderno */
            border-radius: 12px;
            padding: 15px 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            transition: all 0.3s ease;
            flex-grow: 1;
            flex-basis: calc(25% - 15px); /* Quatro itens por linha em telas maiores */
            min-width: 150px;
            max-width: 24%;
        }
        .event-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.4);
        }
        .event-item p {
            margin: 8px 0 0 0;
            font-size: 16px;
            line-height: 1.4;
            color: #e0e0e0;
        }
        .event-item strong {
            color: #64B5F6; /* Azul claro para rótulos */
            font-weight: 600;
            display: block;
            margin-bottom: 3px;
            font-size: 14px;
            text-transform: uppercase;
        }
        .info-icon {
            font-size: 40px !important;
            color: #2196F3; /* Cor do ícone azul */
            margin-bottom: 8px;
        }

        /* Card de Descrição do Evento */
        .description-card {
            background: rgba(60, 60, 60, 0.4);
            backdrop-filter: blur(15px);
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.15);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            margin-bottom: 30px;
            padding: 25px;
        }
        .description-card h5 {
            color: #ffffff;
            font-size: 22px;
            font-weight: 500;
            margin: 0 0 15px 0;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .no-description {
            color: rgba(255,255,255,0.5);
            font-style: italic;
            text-align: center;
        }

        /* Estilos para descrição editável */
        .description-editable {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .description-editable:hover {
            background: rgba(255,255,255,0.08);
        }
        .description-editing {
            background: rgba(33, 150, 243, 0.1) !important;
            border: 2px solid #2196F3 !important;
        }

        .description-edit-area {
            width: 100%;
            background: rgba(255,255,255,0.1);
            border: 1px solid #2196F3;
            border-radius: 8px;
            padding: 15px;
            color: #ffffff;
            font-size: 16px;
            line-height: 1.6;
            resize: vertical;
            min-height: 120px;
            font-family: inherit;
        }
        .description-edit-area:focus {
            outline: none;
            border-color: #64B5F6;
            box-shadow: 0 0 10px rgba(33, 150, 243, 0.3);
        }

        .description-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }

        .description-hint {
            color: rgba(255,255,255,0.4);
            font-size: 14px;
            text-align: center;
            margin-top: 10px;
            font-style: italic;
        }

        /* Cards de Seção (Adicionar Convidado, Lista de Convidados) */
        .section-card {
            background: rgba(60, 60, 60, 0.4); /* Fundo semi-transparente mais escuro */
            backdrop-filter: blur(15px);
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.15);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            margin-bottom: 30px;
        }
        .section-card h5 {
            color: #ffffff;
            font-size: 22px;
            font-weight: 500;
            margin: 0 0 20px 0;
            padding: 25px 25px 0 25px;
            text-align: center;
        }

        /* Estilo dos Campos de Entrada */
        .input-field input[type=text] {
            color: #ffffff !important;
            border-bottom: 1px solid rgba(255,255,255,0.3) !important;
        }
        .input-field input[type=text]:focus {
            border-bottom: 2px solid #2196F3 !important; /* Sublinhado azul ao focar */
            box-shadow: 0 1px 0 0 #2196F3 !important;
        }
        .input-field label {
            color: rgba(255,255,255,0.7) !important;
        }
        .input-field label.active {
            color: #2196F3 !important; /* Rótulo azul quando ativo/focado */
        }

        /* Botão Adicionar Convidado */
        .add-btn {
            background: linear-gradient(45deg, #4CAF50, #388E3C) !important; /* Gradiente verde */
            border-radius: 8px;
            margin-top: 15px;
            transition: all 0.3s ease;
        }
        .add-btn:hover {
            transform: translateY(-2px);
        }

        /* Estilo da Coleção (Lista de Convidados) */
        .collection {
            border: none !important;
            background: transparent;
            margin: 0;
        }
        .collection-item {
            background: rgba(255,255,255,0.03) !important; /* Branco transparente muito sutil */
            border-bottom: 1px solid rgba(255,255,255,0.08) !important;
            color: #e0e0e0 !important;
            transition: all 0.3s ease;
            padding: 20px 25px !important;
        }
        .collection-item:hover {
            background: rgba(255,255,255,0.08) !important;
        }
        .collection-item:last-child {
            border-bottom: none !important;
        }
        .collection-item strong {
            color: #64B5F6;
            font-weight: 500;
        }
        .collection-item.editing {
            background: rgba(33, 150, 243, 0.1) !important; /* Fundo azul claro ao editar */
            border-left: 3px solid #2196F3 !important; /* Borda azul à esquerda */
        }

        /* Botões de Ação (Editar, Excluir, Salvar, Cancelar) */
        .action-btn {
            border-radius: 6px;
            transition: all 0.3s ease;
            height: 36px !important;
            width: 36px !important;
            min-width: 36px !important;
            padding: 0 !important;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
            margin-right: 8px !important;
        }
        .action-btn:hover {
            transform: translateY(-1px);
        }
        .action-btn i {
            font-size: 18px !important;
            margin: 0 !important;
        }
        .edit-btn { background: rgba(255, 193, 7, 0.8) !important; } /* Âmbar */
        .edit-btn:hover { background: rgba(255, 193, 7, 1) !important; }
        .delete-btn { background: rgba(244, 67, 54, 0.8) !important; } /* Vermelho */
        .delete-btn:hover { background: rgba(244, 67, 54, 1) !important; }
        .save-btn { background: rgba(76, 175, 80, 0.8) !important; } /* Verde */
        .save-btn:hover { background: rgba(76, 175, 80, 1) !important; }
        .cancel-btn { background: rgba(158, 158, 158, 0.8) !important; } /* Cinza */
        .cancel-btn:hover { background: rgba(158, 158, 158, 1) !important; }

        /* Campo de Entrada para Edição de Convidados */
        .edit-input {
            background: rgba(255,255,255,0.1) !important;
            border: 1px solid #2196F3 !important;
            border-radius: 4px !important;
            padding: 4px 8px !important;
            color: #ffffff !important;
            font-size: 14px !important;
            width: 100% !important;
            margin: 0 !important;
        }
        .edit-input:focus {
            outline: none !important;
            border-color: #64B5F6 !important;
            box-shadow: 0 0 5px rgba(33, 150, 243, 0.5) !important;
        }

        /* Estilo para quando não há convidados */
        .no-guests {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 40px;
            margin: 25px;
            text-align: center;
        }
        .no-guests p {
            color: rgba(255,255,255,0.7);
            font-size: 16px;
            margin: 0;
        }

        /* Overlay de Carregamento */
        .loading-overlay {
            position: fixed; /* Posição fixa para cobrir a tela inteira */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7); /* Preto semi-transparente */
            display: none; /* Oculto por padrão */
            justify-content: center;
            align-items: center;
            z-index: 9999; /* Garante que fique acima de outros conteúdos */
        }
        /* Animação do Spinner de Carregamento */
        .loading-spinner {
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid #2196F3; /* Borda superior azul para efeito de spinner */
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite; /* Animação de giro */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Modos de exibição para itens de convidado */
        .edit-mode { display: none; } /* Oculto quando não está editando */
        .view-mode { display: inline; } /* Visível quando não está editando */

        /* Ajustes Responsivos */
        @media (max-width: 992px) {
            .event-item {
                flex-basis: calc(50% - 15px); /* Dois itens por linha em telas médias */
                max-width: calc(50% - 15px);
            }
        }
        @media (max-width: 600px) {
            .container {
                margin-top: 10px;
                padding: 0 10px;
            }
            h1 {
                font-size: 28px;
                margin-bottom: 20px;
            }
            .card-content {
                padding: 20px !important;
            }
            .nav-section {
                padding-top: 5px;
                margin-left: -10px; /* Ajustar para telas menores */
            }
            .event-item {
                flex-basis: 100%; /* Um item por linha em telas pequenas */
                max-width: 100%;
                padding: 12px 15px;
            }
            .info-icon {
                font-size: 36px !important;
            }
            .event-item p {
                font-size: 15px;
            }
            .event-item strong {
                font-size: 13px;
            }
            .collection-item {
                padding: 15px 20px !important;
            }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <div class="container">
        <div class="section nav-section">
            <a href="/eventos" class="waves-effect waves-light btn nav-btn">
                <i class="material-icons left">arrow_back</i>Voltar para Lista
            </a>
        </div>

        <div class="row">
            <div class="col s12 m10 offset-m1">
                <h1 class="center-align">Detalhes do <span th:text="${evento.nome}"></span></h1>

                <th:block th:insert="~{mensagemValidacao}"></th:block>

                <div class="section">
                    <div class="card main-card">
                        <div class="card-content">
                            <div class="event-info">
                                <div class="row">
                                    <div class="col s12 m6 l3 event-item">
                                        <i class="material-icons info-icon">event</i>
                                        <p><strong>Nome:</strong> <span th:text="${evento.nome}"></span></p>
                                    </div>
                                    <div class="col s12 m6 l3 event-item">
                                        <i class="material-icons info-icon">location_on</i>
                                        <p><strong>Local:</strong> <span th:text="${evento.local}"></span></p>
                                    </div>
                                    <div class="col s12 m6 l3 event-item">
                                        <i class="material-icons info-icon">date_range</i>
                                        <p><strong>Data:</strong> <span th:text="${evento.data}"></span></p>
                                    </div>
                                    <div class="col s12 m6 l3 event-item">
                                        <i class="material-icons info-icon">access_time</i>
                                        <p><strong>Horário:</strong> <span th:text="${evento.horario}"></span></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Seção da Descrição Editável -->
                <div class="section">
                    <div class="card description-card">
                        <h5><i class="material-icons">description</i>Descrição do Evento</h5>
                        
                        <!-- Modo de Visualização da Descrição -->
                        <div class="description-content description-editable view-mode" id="descriptionView" onclick="editDescription()">
                            <p th:if="${evento.descricao != null and not #strings.isEmpty(evento.descricao)}" th:text="${evento.descricao}"></p>
                            <p th:unless="${evento.descricao != null and not #strings.isEmpty(evento.descricao)}" class="no-description">Clique aqui para adicionar uma descrição ao evento</p>
                        </div>
                        
                        <!-- Modo de Edição da Descrição -->
                        <div class="edit-mode" id="descriptionEdit" style="display: none;">
                            <textarea class="description-edit-area" id="descriptionTextarea" placeholder="Digite a descrição do evento..."></textarea>
                            <div class="description-actions">
                                <button class="btn action-btn save-btn waves-effect waves-light" onclick="saveDescription()">
                                    <i class="material-icons">save</i>
                                </button>
                                <button class="btn action-btn cancel-btn waves-effect waves-light" onclick="cancelDescriptionEdit()">
                                    <i class="material-icons">cancel</i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="description-hint view-mode">
                            Clique na descrição para editá-la
                        </div>
                    </div>
                </div>

                <div class="section">
                    <div class="card section-card">
                        <div class="card-content">
                            <h5>Adicionar Novo Convidado</h5>
                            <form method="post" th:action="@{/detalhesEvento/{codigo}(codigo=${evento.codigo})}">
                                <div class="row">
                                    <div class="input-field col s12 m6">
                                        <input id="nomeConvidado" type="text" name="nomeConvidado" class="validate" required>
                                        <label for="nomeConvidado">Nome do Convidado</label>
                                    </div>
                                    <div class="input-field col s12 m6">
                                        <input id="rg" type="text" name="rg" class="validate" required>
                                        <label for="rg">Número</label>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col s12 center-align">
                                        <button type="submit" class="waves-effect waves-light btn add-btn">
                                            <i class="material-icons left">person_add</i>Adicionar Convidado
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <div class="card section-card">
                        <h5>Lista de Convidados</h5>
                        <div class="collection" th:if="${not #lists.isEmpty(convidados)}">
                            <div class="collection-item" th:each="convidado : ${convidados}" th:data-rg="${convidado.rg}">
                                <div class="row" style="margin-bottom: 0;">
									<div class="col s12 m3">
	                                    <strong>Nome:</strong>
	                                    <span class="view-mode" th:text="${convidado.nomeConvidado}"></span>
	                                    <input type="text" class="edit-input edit-mode" th:value="${convidado.nomeConvidado}" name="nomeConvidado">
	                                </div>
	                                <div class="col s12 m4">
	                                    <strong>Número:</strong>
	                                    <span class="view-mode" th:text="${convidado.rg}"></span>
	                                    <input type="text" class="edit-input edit-mode" th:value="${convidado.rg}" name="rg">
	                                </div>
                                    <div class="col s12 m5 center-align"> <div class="view-mode">
                                            <a class="btn action-btn edit-btn waves-effect waves-light" onclick="editGuest(this)">
                                                <i class="material-icons">edit</i>
                                            </a>
                                            <a th:href="@{'/deletarConvidado/' + ${convidado.rg} + '/' + ${evento.codigo}}"
                                               class="btn action-btn delete-btn waves-effect waves-light" onclick="return confirm('Tem certeza que deseja excluir este convidado?');">
                                                <i class="material-icons">delete</i>
                                            </a>
                                        </div>
                                        <div class="edit-mode">
                                            <a class="btn action-btn save-btn waves-effect waves-light" onclick="saveGuest(this, [[${evento.codigo}]])">
                                                <i class="material-icons">save</i>
                                            </a>
                                            <a class="btn action-btn cancel-btn waves-effect waves-light" onclick="cancelEdit(this)">
                                                <i class="material-icons">cancel</i>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="no-guests" th:unless="${not #lists.isEmpty(convidados)}">
                            <p>Nenhum convidado cadastrado ainda.</p>
                        </div>
                        <div class="col s12 m4" style="padding: 20px 25px;">
                            <p><strong>Total de Convidados:</strong> <span th:text="${totalConvidados}"></span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script>
        // Inicializa os campos de texto do Materialize (rótulos flutuantes)
        document.addEventListener('DOMContentLoaded', () => M.updateTextFields());

        // Obtém o elemento do overlay de carregamento
        const loading = document.getElementById('loadingOverlay');

        /**
         * @function showLoading
         * @description Exibe o overlay de carregamento.
         */
        const showLoading = () => loading.style.display = 'flex';

        /**
         * @function hideLoading
         * @description Oculta o overlay de carregamento.
         */
        const hideLoading = () => loading.style.display = 'none';

        // Variáveis para controle da descrição
        let originalDescription = '';
        const eventoCodigo = [[${evento.codigo}]]; // Obtém o código do evento via Thymeleaf

        /**
         * @function editDescription
         * @description Ativa o modo de edição da descrição do evento
         */
        function editDescription() {
            const viewMode = document.getElementById('descriptionView');
            const editMode = document.getElementById('descriptionEdit');
            const textarea = document.getElementById('descriptionTextarea');
            const hints = document.querySelectorAll('.description-hint');

            // Armazena o conteúdo original
            const descriptionText = viewMode.querySelector('p');
            if (descriptionText && !descriptionText.classList.contains('no-description')) {
                originalDescription = descriptionText.textContent.trim();
            } else {
                originalDescription = '';
            }

            // Preenche o textarea com o conteúdo atual
            textarea.value = originalDescription;

            // Alterna entre os modos
            viewMode.style.display = 'none';
            editMode.style.display = 'block';
            hints.forEach(hint => hint.style.display = 'none');

            // Foca no textarea
            textarea.focus();
        }

        /**
         * @function cancelDescriptionEdit
         * @description Cancela a edição da descrição e volta ao modo de visualização
         */
        function cancelDescriptionEdit() {
            const viewMode = document.getElementById('descriptionView');
            const editMode = document.getElementById('descriptionEdit');
            const hints = document.querySelectorAll('.description-hint');

            // Volta ao modo de visualização
            viewMode.style.display = 'block';
            editMode.style.display = 'none';
            hints.forEach(hint => hint.style.display = 'block');
        }

        /**
         * @function saveDescription
         * @description Salva a descrição editada no servidor
         */
        function saveDescription() {
            const textarea = document.getElementById('descriptionTextarea');
            const newDescription = textarea.value.trim();

            showLoading();

            const data = {
                codigo: eventoCodigo,
                descricao: newDescription
            };

            fetch('/editarDescricaoEvento', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.text())
            .then(result => {
                hideLoading();
                const cleanResult = result.trim();

                if (cleanResult === 'success') {
                    M.toast({html: 'Descrição atualizada com sucesso!', classes: 'green darken-2'});
                    
                    // Atualiza o conteúdo da visualização
                    const viewMode = document.getElementById('descriptionView');
                    const descriptionP = viewMode.querySelector('p');
                    
                    if (newDescription) {
                        if (descriptionP) {
                            descriptionP.textContent = newDescription;
                            descriptionP.classList.remove('no-description');
                        } else {
                            viewMode.innerHTML = `<p>${newDescription}</p>`;
                        }
                    } else {
                        if (descriptionP) {
                            descriptionP.textContent = 'Clique aqui para adicionar uma descrição ao evento';
                            descriptionP.classList.add('no-description');
                        } else {
                            viewMode.innerHTML = '<p class="no-description">Clique aqui para adicionar uma descrição ao evento</p>';
                        }
                    }

                    // Volta ao modo de visualização
                    cancelDescriptionEdit();
                } else {
                    M.toast({html: 'Erro ao salvar descrição. Tente novamente.', classes: 'red'});
                }
            })
            .catch(error => {
                hideLoading();
                console.error('Erro ao salvar descrição:', error);
                M.toast({html: 'Erro de comunicação. Tente novamente.', classes: 'red'});
            });
        }

        /**
         * @function editGuest
         * @param {HTMLElement} btn - O botão de edição clicado.
         * @description Alterna o modo de exibição de um item de convidado do modo de visualização para o modo de edição.
         * Ele oculta elementos do modo de visualização, mostra elementos do modo de edição e adiciona
         * uma classe 'editing' para estilização visual.
         */
        function editGuest(btn) {
            const item = btn.closest('.collection-item');
            // Oculta todos os elementos com a classe 'view-mode' dentro do item
            item.querySelectorAll('.view-mode').forEach(el => el.style.display = 'none');
            // Mostra todos os elementos com a classe 'edit-mode' dentro do item
            item.querySelectorAll('.edit-mode').forEach(el => el.style.display = 'inline');
            // Adiciona a classe 'editing' ao item para estilização específica
            item.classList.add('editing');
            // Foca no campo de entrada do nome para edição imediata
            item.querySelector('input[name="nomeConvidado"]').focus();
        }

        /**
         * @function cancelEdit
         * @param {HTMLElement} btn - O botão de cancelar clicado.
         * @description Reverte um item de convidado do modo de edição para o modo de visualização.
         * Ele oculta elementos do modo de edição, mostra elementos do modo de visualização, remove
         * a classe 'editing' e restaura os valores originais nos campos de entrada.
         */
        function cancelEdit(btn) {
            const item = btn.closest('.collection-item');
            // Mostra todos os elementos com a classe 'view-mode' dentro do item
            item.querySelectorAll('.view-mode').forEach(el => el.style.display = 'inline');
            // Oculta todos os elementos com a classe 'edit-mode' dentro do item
            item.querySelectorAll('.edit-mode').forEach(el => el.style.display = 'none');
            // Remove a classe 'editing' do item
            item.classList.remove('editing');

            // Restaura os valores originais nos campos de entrada
            const nameInput = item.querySelector('input[name="nomeConvidado"]');
            const rgInput = item.querySelector('input[name="rg"]');
            
            // Assuming the structure: <strong>Nome:</strong> <span class="view-mode">...</span>
            // and <strong>Número:</strong> <span class="view-mode">...</span>
            const originalNameSpan = item.querySelector('.view-mode[th:text*="convidado.nomeConvidado"]');
            const originalRgSpan = item.querySelector('.view-mode[th:text*="convidado.rg"]');

            if (nameInput && originalNameSpan) nameInput.value = originalNameSpan.textContent.trim();
            if (rgInput && originalRgSpan) rgInput.value = originalRgSpan.textContent.trim();
            
            // Re-activate Materialize labels for correct display after value reset
            M.updateTextFields();
        }

        /**
         * @function saveGuest
         * @param {HTMLElement} btn - O botão de salvar clicado.
         * @param {number} eventoCodigo - O código do evento ao qual o convidado pertence.
         * @description Salva as informações editadas do convidado no servidor via uma requisição AJAX POST.
         * Ele realiza validação no lado do cliente, mostra um indicador de carregamento, envia os dados
         * e lida com a resposta do servidor (sucesso, RG existente, não encontrado ou erro).
         */
        function saveGuest(btn, eventoCodigo) {
            const item = btn.closest('.collection-item');
            const originalRg = item.dataset.rg; // Obtém o RG original do atributo data-rg
            const nameInput = item.querySelector('input[name="nomeConvidado"]');
            const rgInput = item.querySelector('input[name="rg"]');
            const newName = nameInput.value.trim();
            const newRg = rgInput.value.trim();

            // Validação no lado do cliente
            if (!newName) {
                M.toast({html: 'O nome do convidado não pode estar vazio!', classes: 'red'});
                nameInput.focus();
                return;
            }

            if (!newRg) {
                M.toast({html: 'O número (RG) não pode estar vazio!', classes: 'red'});
                rgInput.focus();
                return;
            }

            showLoading(); // Mostra o indicador de carregamento

            const data = {
                oldRg: originalRg, // Send original RG to identify the guest
                newRg: newRg,      // Send new RG
                nomeConvidado: newName,
                eventoCodigo: eventoCodigo // Send event code
            };

            fetch('/editarConvidado', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data) // Envia dados como JSON
            })
            .then(response => response.text()) // Obtém a resposta como texto
            .then(result => {
                hideLoading(); // Oculta o indicador de carregamento
                const cleanResult = result.trim(); // Remove espaços em branco da resposta

                if (cleanResult === 'success') {
                    M.toast({html: 'Convidado atualizado com sucesso!', classes: 'green darken-2'});
                    // Update the view-mode spans with new values
                    item.querySelector('.view-mode[th:text*="convidado.nomeConvidado"]').textContent = newName;
                    item.querySelector('.view-mode[th:text*="convidado.rg"]').textContent = newRg;
                    item.dataset.rg = newRg; // Update the data-rg attribute for future edits

                    // Revert to view mode
                    item.querySelectorAll('.view-mode').forEach(el => el.style.display = 'inline');
                    item.querySelectorAll('.edit-mode').forEach(el => el.style.display = 'none');
                    item.classList.remove('editing');
                    M.updateTextFields(); // Update Materialize labels
                } else if (cleanResult === 'rg_exists') {
                    M.toast({html: 'Este número (RG) já está sendo usado por outro convidado!', classes: 'red'});
                    rgInput.focus(); // Foca no campo de RG se for duplicado
                } else if (cleanResult === 'not_found') {
                    M.toast({html: 'Convidado não encontrado!', classes: 'red'});
                } else {
                    M.toast({html: 'Erro desconhecido ao salvar. Recarregando página...', classes: 'orange'});
                    setTimeout(() => window.location.reload(), 1500); // Recarrega após um pequeno atraso
                }
            })
            .catch(error => {
                hideLoading(); // Oculta o indicador de carregamento em caso de erro
                console.error('Erro ao salvar convidado:', error);
                // Informa o usuário e recarrega em caso de erro de rede ou não tratado
                M.toast({html: 'Erro de comunicação ao salvar dados. Recarregando página...', classes: 'orange'});
                setTimeout(() => window.location.reload(), 2000);
            });
        }

        // Handle delete guest functionality (using a direct click listener on the delete link)
        document.querySelectorAll('.delete-btn').forEach(button => {
            button.addEventListener('click', function(event) {
                // The 'onclick="return confirm(...)"' already handles the confirmation.
                // If confirmed, the browser will navigate to the th:href URL.
                // We'll let the standard form submission handle the actual deletion and page reload.
                // If you want full AJAX deletion without page reload, you'd preventDefault
                // and use fetch here. For now, assuming standard link behavior after confirmation.

                // If you uncomment the preventDefault, you'd need the fetch logic below:
                // event.preventDefault();
                // const deleteUrl = this.href;
                // showLoading();
                // fetch(deleteUrl, { method: 'GET' }) // Or 'POST' if your backend expects it
                //     .then(response => {
                //         if (response.ok) {
                //             return response.text();
                //         }
                //         throw new Error('Erro ao deletar convidado.');
                //     })
                //     .then(message => {
                //         hideLoading();
                //         M.toast({html: message, classes: 'green darken-2'});
                //         this.closest('.collection-item').remove(); // Remove the list item from the DOM
                //         // Logic to update totalConvidados and 'no guests' message
                //         const totalGuestsElement = document.querySelector('p strong:contains("Total de Convidados:") + span');
                //         if (totalGuestsElement) {
                //             let currentTotal = parseInt(totalGuestsElement.textContent);
                //             totalGuestsElement.textContent = currentTotal > 0 ? currentTotal - 1 : 0;
                //         }
                //         if (document.querySelectorAll('.collection-item').length === 0) {
                //             document.querySelector('.collection').style.display = 'none';
                //             document.querySelector('.no-guests').style.display = 'block';
                //         }
                //     })
                //     .catch(error => {
                //         hideLoading();
                //         console.error('Erro:', error);
                //         M.toast({html: error.message, classes: 'red darken-2'});
                //     });
            });
        });

        // Atalhos de teclado para edição
        document.addEventListener('keydown', function(e) {
            const activeElement = document.activeElement; // Obtém o elemento atualmente focado
            
            // Verifica se o elemento focado é um dos campos de entrada de edição
            if (activeElement && activeElement.classList.contains('edit-input')) {
                const item = activeElement.closest('.collection-item'); // Obtém o item pai do convidado

                if (e.key === 'Enter') {
                    // Se a tecla Enter for pressionada, tenta salvar o convidado
                    const saveBtn = item.querySelector('.save-btn');
                    if (saveBtn) saveGuest(saveBtn, eventoCodigo);
                } else if (e.key === 'Escape') {
                    // Se a tecla Escape for pressionada, cancela a edição
                    const cancelBtn = item.querySelector('.cancel-btn');
                    if (cancelBtn) cancelEdit(cancelBtn);
                }
            }
            
            // Atalhos de teclado para edição da descrição
            if (activeElement && activeElement.id === 'descriptionTextarea') {
                if (e.key === 'Enter' && e.ctrlKey) {
                    // Ctrl + Enter para salvar a descrição
                    e.preventDefault();
                    saveDescription();
                } else if (e.key === 'Escape') {
                    // Escape para cancelar edição da descrição
                    e.preventDefault();
                    cancelDescriptionEdit();
                }
            }
        });
    </script>
</body>
</html>